# Инструкции для разработки Blueprintflow

## Общие цели
- Корпоративный портал для отдела анализа рабочей документации и смет.
- Поддержка OAuth2 (Google, Microsoft) поверх Supabase Auth.
- Роли: Администратор, Инженер, Просмотр.
- Импорт ВОР, смет и шахматок из Excel/CSV.
- Библиотека работ и материалов для повторного использования.
- Дашборд аналитики: win-rate, динамика затрат и др.
- Onboarding‑wizard и AI‑подсказки Codex.
- Соответствие WCAG 2.1 AA, mobile‑first дизайн.
- Optimistic locking и разрешение конфликтов при совместном редактировании.

## Архитектура и стек
- Frontend: React 18, TypeScript, Vite, Ant Design 5, TanStack Query.
- Real‑time: Supabase Realtime WebSocket.
- Backend: Supabase (PostgreSQL 16, Edge Functions Deno, Storage).
- DevOps: GitHub Actions → Vercel (FE) / Supabase Cloud (BE).
- Observability: Sentry, Grafana Cloud, OTEL.

## Требования по файлам
- Загрузка файлов drag‑and‑drop до 250 МБ.
- Предпросмотр PDF, изображений, XLS, DOC/TXT/RTF/ODT.
- Версионирование по подпапкам с датой.

## Синхронность
- Supabase Realtime канал `Blueprintflow:{id}`.
- Optimistic locking по `updated_at`.
- Разрешение конфликтов: Объединить / Перезаписать / Откатить.
- Цель latency < 300 мс.

## Библиотека позиций
- Таблицы `works` и `materials`.
- Импорт из Excel и прошлых тендеров/расчетов.
- Поиск по классификатору (при необходимости ГЭСН/ТСН).

## Аналитика
- Дашборд: количество шахматок, ВОР, затраты, суммы ДС и др.
- Отчёты XLSX/PDF.
- Графики договорной стоимости, стоимости с учётом ДС, суммы затрат.

## Нефункциональные требования
- Импорт 5000 строк Excel ≤ 30 с; рендер 10000 строк ≤ 100 мс.
- 100 одновременных пользователей (k6: 100 VU × 2 мин без ошибок).
- Доступность 99,9% в месяц; mobile‑friendly; WCAG 2.1 AA.
- Безопасность: TLS 1.3, RLS, MFA; ноль критических OWASP‑рисков.
- Горизонтальная масштабируемость Realtime.
- Управляемость: history_log, Sentry alerts, MTTR ≤ 5 мин.

## Критерии приёмки
- Импорт 5000 строк ≤ 30 с.
- Совместное редактирование без конфликтов, latency < 300 мс.
- Корректный пересчёт цен при изменении расценок и коэффициентов.
- Полная запись действий в `history_log`.
- OWASP ZAP: 0 критических уязвимостей.
- API `/Blueprintflow/{id}/rows` (95‑й перцентиль) < 150 мс.
- Дашборд win‑rate обновляется минимум раз в сутки.
