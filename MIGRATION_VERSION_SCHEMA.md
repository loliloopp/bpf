# Миграция схемы для версий документов

## Описание изменений

Изменена схема таблицы `chessboard_documentation_mapping` для работы с версиями документов:

- Поле `documentation_id` заменено на `version_id`
- Теперь таблица ссылается напрямую на `documentation_versions` вместо `documentations`
- Каждая запись в шахматке привязана к конкретной версии документа (шифр + версия)
- **ВАЖНО**: Существующие записи будут автоматически привязаны к последним версиям документов

## Применение миграции

⚠️ **Перед применением рекомендуется создать резервную копию БД**

```bash
psql "$DATABASE_URL" -f sql/add_version_to_chessboard_documentation_mapping.sql
```

## Откат миграции (если необходимо)

```bash
psql "$DATABASE_URL" -f sql/rollback_version_migration.sql
```

## Что происходит при миграции

1. Удаляются записи с несуществующими `documentation_id`
2. Добавляется поле `version_id`
3. Существующие записи автоматически привязываются к последним версиям документов
4. Удаляются записи без соответствующих версий
5. Удаляется старое поле `documentation_id`
6. Создается внешний ключ на `documentation_versions`

## После миграции

1. Обновить код согласно `VERSION_SCHEMA_UPDATE.md`
2. Проверить функциональность версий в интерфейсе

## Требования к пользователям

- Версия документа должна быть выбрана через кнопку "Версии" перед добавлением/редактированием строк
- Без выбора версии сохранение записей невозможно