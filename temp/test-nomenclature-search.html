<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-title {
            font-weight: bold;
            color: #1890ff;
            margin-bottom: 10px;
        }
        .result {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .success {
            color: #52c41a;
        }
        .error {
            color: #ff4d4f;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #1890ff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #40a9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –≤ Supabase –ë–î</h1>

        <div class="test-section">
            <div class="test-title">1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase</div>
            <button onclick="testConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
            <div id="connection-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2. –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—ã nomenclature</div>
            <button onclick="getTableStats()">–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
            <div id="stats-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3. –ü–æ–∏—Å–∫ "–ø–µ–Ω–æ–ø–æ–ª–∏—Å—Ç–∏—Ä–æ–ª"</div>
            <button onclick="searchPenopolistirol()">–ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å–∏ —Å "–ø–µ–Ω–æ–ø–æ–ª–∏—Å—Ç–∏—Ä–æ–ª"</button>
            <div id="penopolistirol-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. –ü–æ–∏—Å–∫ "—Ç–µ–ø–ª–æ–∏–∑–æ–ª—è—Ü–∏—è"</div>
            <button onclick="searchTeploizolyacia()">–ù–∞–π—Ç–∏ –∑–∞–ø–∏—Å–∏ —Å "—Ç–µ–ø–ª–æ–∏–∑–æ–ª—è—Ü–∏—è"</button>
            <div id="teploizolyacia-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø–æ–∏—Å–∫</div>
            <input type="text" id="custom-search" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å" />
            <button onclick="customSearch()">–ü–æ–∏—Å–∫</button>
            <div id="custom-result" class="result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">6. –¢–µ—Å—Ç ML –ø–æ–∏—Å–∫–∞</div>
            <input type="text" id="ml-search" placeholder="–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è ML –ø–æ–∏—Å–∫–∞" value="–ø–µ–Ω–æ–ø–æ–ª–∏—Å—Ç–∏—Ä–æ–ª —ç–∫—Å—Ç—Ä—É–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π" />
            <button onclick="testMLSearch()">ML –ü–æ–∏—Å–∫</button>
            <div id="ml-result" class="result"></div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞
        const supabaseUrl = 'https://hfqgcaxmufzitdfafdlp.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmcWdjYXhtdWZ6aXRkZmFmZGxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4OTI5MjMsImV4cCI6MjA3MDQ2ODkyM30.XnOEKdwZdJM-DilhrjZ7PdzHU2rx3L72oQ1rJYo5pXc'

        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        async function testConnection() {
            const resultDiv = document.getElementById('connection-result')
            resultDiv.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...'

            try {
                const { data, error } = await supabase
                    .from('nomenclature')
                    .select('count', { count: 'exact', head: true })
                    .limit(1)

                if (error) {
                    resultDiv.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</span>`
                } else {
                    resultDiv.innerHTML = `<span class="success">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!</span>\n\n–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ nomenclature: ${data || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`
                }
            } catch (e) {
                resultDiv.innerHTML = `<span class="error">‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${e.message}</span>`
            }
        }

        async function getTableStats() {
            const resultDiv = document.getElementById('stats-result')
            resultDiv.textContent = '–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...'

            try {
                // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
                const { count, error: countError } = await supabase
                    .from('nomenclature')
                    .select('*', { count: 'exact', head: true })

                if (countError) {
                    resultDiv.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞: ${countError.message}</span>`
                    return
                }

                // –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–∏—Å–µ–π
                const { data: samples, error: samplesError } = await supabase
                    .from('nomenclature')
                    .select('id, name')
                    .limit(5)

                if (samplesError) {
                    resultDiv.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤: ${samplesError.message}</span>`
                    return
                }

                let result = `<span class="success">‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞–±–ª–∏—Ü—ã nomenclature:</span>\n\n`
                result += `–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${count}\n\n`
                result += `–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–∏—Å–µ–π:\n`
                samples.forEach((item, index) => {
                    result += `${index + 1}. [${item.id}] ${item.name}\n`
                })

                resultDiv.innerHTML = result
            } catch (e) {
                resultDiv.innerHTML = `<span class="error">‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${e.message}</span>`
            }
        }

        async function searchPenopolistirol() {
            const resultDiv = document.getElementById('penopolistirol-result')
            resultDiv.textContent = '–ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–µ–π —Å "–ø–µ–Ω–æ–ø–æ–ª–∏—Å—Ç–∏—Ä–æ–ª"...'

            try {
                const { data, error } = await supabase
                    .from('nomenclature')
                    .select('id, name')
                    .ilike('name', '%–ø–µ–Ω–æ–ø–æ–ª–∏—Å—Ç–∏—Ä–æ–ª%')
                    .limit(10)

                if (error) {
                    resultDiv.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</span>`
                    return
                }

                if (!data || data.length === 0) {
                    resultDiv.innerHTML = `<span class="error">‚ùå –ó–∞–ø–∏—Å–∏ —Å "–ø–µ–Ω–æ–ø–æ–ª–∏—Å—Ç–∏—Ä–æ–ª" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</span>`
                    return
                }

                let result = `<span class="success">‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data.length} –∑–∞–ø–∏—Å–µ–π —Å "–ø–µ–Ω–æ–ø–æ–ª–∏—Å—Ç–∏—Ä–æ–ª":</span>\n\n`
                data.forEach((item, index) => {
                    result += `${index + 1}. [${item.id}] ${item.name}\n`
                })

                resultDiv.innerHTML = result
            } catch (e) {
                resultDiv.innerHTML = `<span class="error">‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${e.message}</span>`
            }
        }

        async function searchTeploizolyacia() {
            const resultDiv = document.getElementById('teploizolyacia-result')
            resultDiv.textContent = '–ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–µ–π —Å "—Ç–µ–ø–ª–æ–∏–∑–æ–ª—è—Ü–∏—è"...'

            try {
                const { data, error } = await supabase
                    .from('nomenclature')
                    .select('id, name')
                    .ilike('name', '%—Ç–µ–ø–ª–æ–∏–∑–æ–ª—è—Ü%')
                    .limit(10)

                if (error) {
                    resultDiv.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</span>`
                    return
                }

                if (!data || data.length === 0) {
                    resultDiv.innerHTML = `<span class="error">‚ùå –ó–∞–ø–∏—Å–∏ —Å "—Ç–µ–ø–ª–æ–∏–∑–æ–ª—è—Ü" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</span>`
                    return
                }

                let result = `<span class="success">‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data.length} –∑–∞–ø–∏—Å–µ–π —Å "—Ç–µ–ø–ª–æ–∏–∑–æ–ª—è—Ü":</span>\n\n`
                data.forEach((item, index) => {
                    result += `${index + 1}. [${item.id}] ${item.name}\n`
                })

                resultDiv.innerHTML = result
            } catch (e) {
                resultDiv.innerHTML = `<span class="error">‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${e.message}</span>`
            }
        }

        async function customSearch() {
            const searchTerm = document.getElementById('custom-search').value.trim()
            const resultDiv = document.getElementById('custom-result')

            if (!searchTerm) {
                resultDiv.innerHTML = `<span class="error">‚ùå –í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</span>`
                return
            }

            resultDiv.textContent = `–ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–µ–π —Å "${searchTerm}"...`

            try {
                const { data, error } = await supabase
                    .from('nomenclature')
                    .select('id, name')
                    .ilike('name', `%${searchTerm}%`)
                    .limit(15)

                if (error) {
                    resultDiv.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</span>`
                    return
                }

                if (!data || data.length === 0) {
                    resultDiv.innerHTML = `<span class="error">‚ùå –ó–∞–ø–∏—Å–∏ —Å "${searchTerm}" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</span>`
                    return
                }

                let result = `<span class="success">‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data.length} –∑–∞–ø–∏—Å–µ–π —Å "${searchTerm}":</span>\n\n`
                data.forEach((item, index) => {
                    result += `${index + 1}. [${item.id}] ${item.name}\n`
                })

                resultDiv.innerHTML = result
            } catch (e) {
                resultDiv.innerHTML = `<span class="error">‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${e.message}</span>`
            }
        }

        async function testMLSearch() {
            const materialName = document.getElementById('ml-search').value.trim()
            const resultDiv = document.getElementById('ml-result')

            if (!materialName) {
                resultDiv.innerHTML = `<span class="error">‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</span>`
                return
            }

            resultDiv.textContent = `ML –ø–æ–∏—Å–∫ –¥–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ "${materialName}"...`

            try {
                const startTime = Date.now()

                // –ò–º–∏—Ç–∞—Ü–∏—è ML –ª–æ–≥–∏–∫–∏ –∏–∑ –∫–æ–¥–∞
                const searchTerm = materialName.toLowerCase().trim()

                // –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π
                const { data: matches, error } = await supabase
                    .from('nomenclature')
                    .select('id, name')
                    .ilike('name', `%${searchTerm}%`)
                    .limit(100)

                if (error) {
                    resultDiv.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ ML –ø–æ–∏—Å–∫–∞: ${error.message}</span>`
                    return
                }

                const processingTime = Date.now() - startTime

                if (!matches || matches.length === 0) {
                    resultDiv.innerHTML = `<span class="error">‚ùå ML –ø–æ–∏—Å–∫ –Ω–µ –Ω–∞—à–µ–ª —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –¥–ª—è "${materialName}"</span>\n\n–í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞: ${processingTime}–º—Å`
                    return
                }

                // –ü—Ä–æ—Å—Ç–∞—è —Å–∏–º—É–ª—è—Ü–∏—è ML —Å–∫–æ—Ä–∏–Ω–≥–∞
                const suggestions = matches.map(nom => {
                    const nomLower = nom.name.toLowerCase()
                    const hasExactMatch = nomLower.includes(searchTerm)
                    const hasPrefixMatch = nomLower.startsWith(searchTerm)

                    let confidence = 0.3 // –±–∞–∑–æ–≤–∞—è confidence
                    if (hasExactMatch) confidence += 0.4
                    if (hasPrefixMatch) confidence += 0.3

                    return {
                        ...nom,
                        confidence: Math.min(0.95, confidence),
                        reasoning: `Exact: ${hasExactMatch}, Prefix: ${hasPrefixMatch}`
                    }
                })
                .filter(s => s.confidence >= 0.3)
                .sort((a, b) => b.confidence - a.confidence)
                .slice(0, 10)

                let result = `<span class="success">‚úÖ ML –Ω–∞—à–µ–ª ${suggestions.length} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∑–∞ ${processingTime}–º—Å:</span>\n\n`
                suggestions.forEach((item, index) => {
                    result += `${index + 1}. [${Math.round(item.confidence * 100)}%] ${item.name}\n`
                    result += `    –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: ${item.reasoning}\n\n`
                })

                resultDiv.innerHTML = result
            } catch (e) {
                resultDiv.innerHTML = `<span class="error">‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ ML –ø–æ–∏—Å–∫–µ: ${e.message}</span>`
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            testConnection()
        })
    </script>
</body>
</html>