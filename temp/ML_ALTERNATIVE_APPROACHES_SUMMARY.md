# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é ML –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

## –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∞ 400 Bad Request –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ML –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å `nomenclature_id: null` –≤ —Ç–∞–±–ª–∏—Ü—É `chessboard_nomenclature_mapping`.

## –ü—Ä–∏—á–∏–Ω–∞
–í production —Å—Ö–µ–º–µ –ë–î –ø–æ–ª–µ `nomenclature_id` –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ `NOT NULL` –∏ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é —Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞.

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. –ë–´–°–¢–†–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ML —Ä–µ–∂–∏–º–∞:

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ —Ä–µ–∂–∏–º–∞: —Å –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–æ–π –∏ –±–µ–∑

**SQL –º–∏–≥—Ä–∞—Ü–∏—è:** `/sql/fix_chessboard_nomenclature_mapping_for_ml.sql`

### 2. –°–û–ó–î–ê–ù–ò–ï –û–¢–î–ï–õ–¨–ù–û–ô –¢–ê–ë–õ–ò–¶–´ –î–õ–Ø ML –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ô

```sql
CREATE TABLE public.chessboard_ml_suggestions (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    chessboard_id uuid NOT NULL REFERENCES public.chessboard(id) ON DELETE CASCADE,
    supplier_name text NOT NULL,
    confidence_score numeric(3,2), -- 0.00-1.00
    ml_source text, -- 'deepseek', 'openai', 'local' –∏ —Ç.–¥.
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),

    UNIQUE(chessboard_id, supplier_name)
);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –ú–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é ML –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ö–µ–º—É

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### 3. –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï –°–ü–ï–¶–ò–ê–õ–¨–ù–û–ì–û UUID –î–õ–Ø ML –ó–ê–ü–ò–°–ï–ô

–°–æ–∑–¥–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `nomenclature` –¥–ª—è ML –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:

```sql
INSERT INTO public.nomenclature (id, name)
VALUES ('00000000-0000-0000-0000-000000000001', '[ML_SUGGESTION]')
ON CONFLICT (id) DO NOTHING;
```

–ó–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç ID –¥–ª—è –≤—Å–µ—Ö ML –∑–∞–ø–∏—Å–µ–π, –∞ —Ä–µ–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤ `supplier_name`.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—Ö–µ–º–µ –ë–î
- –†–∞–±–æ—Ç–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ constraints

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- "–•–∞–∫" –≤ —Å—Ö–µ–º–µ –¥–∞–Ω–Ω—ã—Ö
- –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—É—Ç–∞–Ω–∏—Ü—É –≤ –æ—Ç—á–µ—Ç–∞—Ö

### 4. JSONB –ü–û–õ–ï –î–õ–Ø –•–†–ê–ù–ï–ù–ò–Ø ML –î–ê–ù–ù–´–•

–î–æ–±–∞–≤–∏—Ç—å JSONB –ø–æ–ª–µ –≤ —Ç–∞–±–ª–∏—Ü—É `chessboard` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ML –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:

```sql
ALTER TABLE public.chessboard
ADD COLUMN ml_suggestions jsonb DEFAULT '[]'::jsonb;

-- –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
-- [
--   {
--     "supplier_name": "–ü–ª–∏—Ç—ã –º–∏–Ω–µ—Ä–∞–ª–æ–≤–∞—Ç–Ω–∞—è –¢–µ—Ö–Ω–æ—Ñ–∞—Å –î–µ–∫–æ—Ä",
--     "confidence": 0.95,
--     "source": "deepseek"
--   }
-- ]
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ì–∏–±–∫–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è ML –¥–∞–Ω–Ω—ã—Ö
- –ù–µ –Ω–∞—Ä—É—à–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ö–µ–º—É
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –£—Å–ª–æ–∂–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
- –ú–µ–Ω–µ–µ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–†–ï–ö–û–ú–ï–ù–î–£–Æ –í–ê–†–ò–ê–ù–¢ 1**: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ SQL –º–∏–≥—Ä–∞—Ü–∏—é.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏:

```typescript
// –í useTableOperations.ts –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —É–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ nomenclatureId
if (updates.supplier) { // –£–±–∏—Ä–∞–µ–º: || nomenclatureId
  console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º ML –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:', {
    chessboard_id: rowId,
    nomenclature_id: nomenclatureId, // –º–æ–∂–µ—Ç –±—ã—Ç—å null
    supplier_name: updates.supplier,
  })

  promises.push(
    supabase.from('chessboard_nomenclature_mapping').insert({
      chessboard_id: rowId,
      nomenclature_id: nomenclatureId, // null —Ä–∞–∑—Ä–µ—à—ë–Ω –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
      supplier_name: updates.supplier,
    }),
  )
}
```

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

```bash
# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é –∫ –ë–î
psql "$DATABASE_URL" -f sql/fix_chessboard_nomenclature_mapping_for_ml.sql

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
npm run dev
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏:

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫:
```json
{
  "chessboard_id": "ff9fcf43-1c58-492a-9006-6133981d582a",
  "nomenclature_id": null,
  "supplier_name": "–ü–ª–∏—Ç—ã –º–∏–Ω–µ—Ä–∞–ª–æ–≤–∞—Ç–Ω–∞—è –¢–µ—Ö–Ω–æ—Ñ–∞—Å –î–µ–∫–æ—Ä 1200—Ö600—Ö100–º–º"
}
```