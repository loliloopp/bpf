# Исправление отображения стилобатов и подземного паркинга

## 🐛 **Проблемы:**
1. На карточке проекта не отображались стилобаты и подземный паркинг между корпусами
2. В таблице `block_connections_mapping` подземные соединения назывались "Подземное соединение" вместо "Подземный паркинг"

## ✅ **Исправления:**

### 1. Унификация типов соединений
**Изменение типа "Подземное соединение" → "Подземный паркинг":**

**В коде (`Projects.tsx`):**
```typescript
// Было
'Подземное соединение'

// Стало
'Подземный паркинг'
```

**В типах (`types.ts` и `projects-api.ts`):**
```typescript
// Было
connection_type: 'Стилобат' | 'Подземное соединение' | 'Подземный паркинг'

// Стало
connection_type: 'Стилобат' | 'Подземный паркинг'
```

**Логика различения:**
- **`to_block_id !== null`** - подземный паркинг между корпусами
- **`to_block_id === null`** - подземный паркинг под одним корпусом

### 2. Исправление функции загрузки данных
**В `loadProjectCardData()` в `Projects.tsx`:**
```typescript
// Различаем два типа подземного паркинга
const undergroundConnections = connections?.filter(c =>
  c.connection_type === 'Подземный паркинг' && c.to_block_id !== null
) || []

const undergroundParkingIds = connections?.filter(c =>
  c.connection_type === 'Подземный паркинг' && c.to_block_id === null
).map(c => c.from_block_id) || []
```

### 3. Добавление отладочной информации
**В `ProjectCardModal.tsx`:**
- Добавлен детальный лог данных при построении таблицы
- Отладка соединений между корпусами для диагностики проблем
- Улучшена логика обработки пустых ячеек

### 4. SQL миграция для базы данных
**Создан файл `sql/002_update_connection_type_enum.sql`:**
```sql
-- Обновляем существующие записи
UPDATE public.block_connections_mapping
SET connection_type = 'Подземный паркинг'
WHERE connection_type = 'Подземное соединение';

-- Обновляем enum тип, убирая 'Подземное соединение'
CREATE TYPE public.connection_type_new AS ENUM (
    'Стилобат',
    'Подземный паркинг'
);
```

## 🔧 **Технические детали:**

### Структура данных в БД:
```
block_connections_mapping:
- Стилобат: from_block_id ↔ to_block_id (связь между корпусами)
- Подземный паркинг (между корпусами): from_block_id ↔ to_block_id
- Подземный паркинг (под корпусом): from_block_id, to_block_id = NULL
```

### Логика отображения в UI:
```typescript
// Стилобаты - для положительных этажей
if (stylobate && floor > 0 && floor <= stylobate.floors) {
  // Отображаем стилобат
}
// Подземный паркинг - для этажа 0 и отрицательных
else if (connection && floor <= 0) {
  // Отображаем подземное соединение
}
```

### Отладочная информация:
- Логи структуры данных при построении таблицы
- Детальная информация о найденных соединениях
- Проверка корректности маппинга ID корпусов

## 🧪 **Ожидаемый результат:**
- ✅ Стилобаты отображаются между корпусами в карточке проекта
- ✅ Подземный паркинг отображается между связанными корпусами
- ✅ Унифицированная терминология: только "Подземный паркинг"
- ✅ Корректное различение типов паркинга (между корпусами / под корпусом)

## 📋 **Инструкции по применению:**
1. Применить SQL миграцию: `psql "$DATABASE_URL" -f sql/002_update_connection_type_enum.sql`
2. Проверить отображение стилобатов и подземного паркинга в карточке проекта
3. При необходимости использовать отладочные логи для диагностики