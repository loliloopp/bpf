# Доработка системы корпусов - Changelog

## Реализованные изменения

### 1. Создана новая таблица маппинга связей между корпусами
- **Файл**: `sql/001_create_block_connections_mapping.sql`
- **Назначение**: Отдельная таблица для хранения связей между корпусами
- **Возможности**:
  - Стилобаты между корпусами с указанием количества этажей
  - Подземные соединения между корпусами
  - Подземные паркинги под корпусами

### 2. Обновлена структура базы данных
- **Новые типы данных**: `connection_type` enum со значениями:
  - `'Стилобат'` - для стилобатов между корпусами
  - `'Подземное соединение'` - для подземных соединений
  - `'Подземный паркинг'` - для паркингов под корпусами

### 3. Переименование в UI
- **Изменено**: "Подз.парковка" → "Подз.паркинг"
- **Затронутые компоненты**: `ProjectCardModal.tsx`

### 4. Создано API для работы с новой структурой
- **Файлы**:
  - `src/entities/projects/api/projects-api.ts`
  - `src/entities/projects/model/types.ts`
  - `src/entities/projects/index.ts`
- **Функционал**:
  - Создание и управление блоками
  - Создание связей между блоками
  - Управление этажами блоков с типизацией

### 5. Доработана логика добавления элементов

#### Стилобаты:
- При добавлении стилобата между корпусами создается:
  - Запись в `block_connections_mapping` с типом "Стилобат"
  - Отдельный блок в таблице `blocks` с именем "Стилобат (Корпус1-Корпус2)"
  - Этажи стилобата в `block_floor_mapping` с `type_blocks = 'Стилобат'`

#### Подземные паркинги:
- При добавлении паркинга под корпусом:
  - Подземные этажи относятся к паркингу, а не к корпусу
  - В `block_floor_mapping` для подземных этажей устанавливается `type_blocks = 'Подземный паркинг'`
  - Создается запись в `block_connections_mapping` для отслеживания паркинга

#### Подземные соединения:
- При соединении корпусов подземными переходами:
  - Создается запись в `block_connections_mapping` с типом "Подземное соединение"

### 6. Обновлена логика сохранения в модальном окне
- **Компонент**: `ProjectCardModal.tsx`
- **Новые возможности**:
  - Автоматическое создание блоков в БД при нажатии "Сохранить"
  - Правильная типизация этажей (корпус/паркинг/стилобат/кровля)
  - Создание связей между блоками
  - Обработка ошибок с уведомлениями пользователя

## Структура данных

### Таблица `block_connections_mapping`
```sql
CREATE TABLE public.block_connections_mapping (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    from_block_id uuid NOT NULL,
    to_block_id uuid, -- NULL для паркинга под одним корпусом
    connection_type public.connection_type NOT NULL,
    floors_count integer DEFAULT 1,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);
```

### Enum `connection_type`
```sql
CREATE TYPE public.connection_type AS ENUM (
    'Стилобат',
    'Подземное соединение',
    'Подземный паркинг'
);
```

## Логика работы системы

1. **Создание корпуса**: Блок создается в таблице `blocks`, привязывается к проекту через `projects_blocks`
2. **Добавление этажей**: Этажи добавляются в `block_floor_mapping` с правильным типом
3. **Создание стилобата**:
   - Отдельный блок с именем "Стилобат (Корпус1-Корпус2)"
   - Связь в `block_connections_mapping`
   - Этажи стилобата с типом "Стилобат"
4. **Подземный паркинг**: Подземные этажи корпуса получают тип "Подземный паркинг"

## Применение миграций

Для применения изменений в базе данных:
```bash
psql "$DATABASE_URL" -f sql/001_create_block_connections_mapping.sql
```