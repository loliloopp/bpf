# Анализ проблемы ML поиска номенклатуры

## Результаты проверки структуры таблицы nomenclature

### 1. Количество записей в таблице nomenclature
- **Всего записей**: ~186,770 записей
- **Размер файла схемы**: 579,416 строк
- **Дата создания данных**: 2025-08-29

### 2. Структура таблицы nomenclature
```sql
CREATE TABLE public.nomenclature (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name text NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
```

### 3. Индексы и ограничения
- **Первичный ключ**: `materials_pkey` на поле `id` (UUID)
- **Уникальное ограничение**: `materials_name_key` на поле `name` (UNIQUE)
- **НЕТ полнотекстовых индексов**: отсутствуют GIN индексы для ускорения ILIKE поиска

### 4. Проверка наличия записей с "лифт"
В таблице найдено **множество записей** с лифтами, включая:
- Лифт пассажирский, модели GeN2 без машинного помещения, 630 кг (различные этажности)
- Лифт пассажирский IDA MRL 630 кг
- Лифт пассажирский WD 800 MRL, 630 кг
- Лифт пассажирский М300 SJEC 630 кг

**Примеры точных совпадений для поиска "Лифт пассажирский 630 кг":**
```
1af4cdf8-31cf-4272-bd6f-2b912d14eafa | Лифт пассажирский, модели GeN2 без машинного помещения, 630 кг, 25 ост. (E2NВ-2300) (монтаж СУ10) (компл)
37cf852d-9cb1-4c13-a026-064c1297c896 | Лифт пассажирский, модели GeN2 без машинного помещения, 630 кг, 26 ост. (E2NВ-2284) (монтаж СУ10) (компл)
ee02fdfc-d909-4166-8fc9-551d481eb501 | Лифт пассажирский, модели М300 SJEC 630 кг, 29 ост. v=2,0 м/с h=102,0 м El 60 (шт)
```

## Анализ ML API и поискового алгоритма

### 1. Многоступенчатый поиск в ml-api.ts
ML API использует следующую логику поиска:

#### Этап 1: Точное совпадение и начало строки
```typescript
.or(`name.ilike.${searchTerm}%,name.ilike.%${searchTerm}%`)
```

#### Этап 2: Поиск по словам
```typescript
const words = searchTerm.split(/\s+/).filter(word => word.length >= 2)
const wordConditions = words.map(word => `name.ilike.%${word}%`).join(',')
```

### 2. Потенциальные проблемы

#### Проблема №1: Синтаксис Supabase OR запроса
В строке 118 есть потенциально некорректный SQL:
```typescript
query = query.not('id', 'in', `(${exactIds})`)
```
Это может приводить к невалидному SQL запросу.

#### Проблема №2: Обработка пустых результатов exactMatches
Если `exactMatches` null или undefined, это может приводить к ошибкам в последующих операциях.

#### Проблема №3: Сложность поискового запроса
При поиске "Лифт пассажирский 630 кг" создается сложный OR запрос, который может не работать корректно.

### 3. Тест с поисковым запросом "лифт"

Для запроса:
```sql
SELECT id, name FROM nomenclature WHERE name ILIKE '%лифт%' LIMIT 20;
```

**Ожидаемый результат**: Должен найти десятки записей с лифтами.

## Рекомендации по исправлению

### 1. Упростить логику поиска
Заменить сложный многоступенчатый поиск на более простой и надежный:

```typescript
// Простой ILIKE поиск с OR условием
const { data, error } = await supabase
  .from('nomenclature')
  .select('id, name')
  .ilike('name', `%${searchTerm}%`)
  .order('name')
  .limit(50)
```

### 2. Добавить индексы для производительности
Добавить GIN индекс для ускорения поиска:
```sql
CREATE INDEX idx_nomenclature_name_gin ON nomenclature
USING gin(to_tsvector('russian', name));
```

### 3. Исправить обработку ошибок
Добавить проверки на null/undefined результаты.

### 4. Упростить ML алгоритм similarity
Текущий алгоритм Levenshtein distance может быть слишком медленным для 186k записей.

## Вывод

Проблема НЕ в отсутствии данных - в таблице nomenclature есть множество записей с лифтами. Проблема в сложной логике поиска ML API, которая может содержать синтаксические ошибки или некорректную обработку результатов Supabase запросов.

**Приоритет исправления**: ВЫСОКИЙ
**Рекомендуемое решение**: Упростить поисковый алгоритм и добавить отладочные логи для диагностики.